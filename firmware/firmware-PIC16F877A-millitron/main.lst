MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001  title "main.asm   - Autoklavier Main Test"
                      00002 #define _version "2.1"
                      00003 
                      00004 ; Update History: 
                      00005 ; 1.12.2003 initial build (V 0.01a)
                      00006 ; 10.12.2003 first release (V 0.01)
                      00007 ; 10.1.2004  added serial interrupt, debuuged timer int (V1.0)
                      00008 ; 18.10.2004 neue hardware (V2.0)
                      00009 ; 31.7.2005 neue relais (V2.1)
                      00010 
                      00011 ; Autoklavierspieler für relais
                      00012 ;
                      00013 ; Author: Winfried Ritsch
                      00014 ; (c) ALGO 2003 
                      00015 ;   
                      00016 ; Hardware Notes:
                      00017 ; build for PIC-Controller 16LF877A - 20Mhz
                      00018 ; special made for Autoklavier
                      00019 
                      00020 ; Hints:
                      00021 ; Clock 20 MHz -> 5.000.000 Instruction /sec 
                      00022 ; State Machine Programm
                      00023 ; Main loop sollte nie auf wait gehen und 
                      00024 ; 
                      00025 ; Code immer im Bank0 Status halten
                      00026 
                      00027 ; 1.) assembler Directives
                      00028 
                      00029 ;       list p=16f877A   ; von MPLAP aus spezifiert
                      00030         list R=DEC       ; Basis der Zahlen ist default 10
                      00031 
                      00032 ; 2.) Header Includes                                                                                   
                                                                                                                            
                      00033 
                      00034         include "p16F877A.inc"    ; Prozessor defs (mplab)
                      00001         LIST
                      00002 ; P16F877A.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00398         LIST
                      00035         include "hardware.inc"    ; my hardware defs
                      00001 ; My hardware definitions
                      00002 ; (c) ALGO 2003
                      00003 
                      00004 ; -------- Tasten in --------------
  00000000            00005 tpoti  EQU 0
                      00006 #define TPOTI PORTA,tpoti
                      00007 
                      00008 ; ---  RA1 == 1 -> addressmode ---
  00000001            00009 addrvalid EQU 1
                      00010 #define ADDRVALID PORTA,addrvalid
                      00011 
  00000002            00012 taddr1 EQU 2
                      00013 #define TADDR1 PORTA,taddr1
                      00014 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  2
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000003            00015 taddr2 EQU 3
                      00016 #define TADDR2 PORTA,taddr2
                      00017 
  00000004            00018 taddr3 EQU 4
                      00019 #define TADDR3 PORTA,taddr3
                      00020 
                      00021 ; ---  RA1 == 0 -> testmode ---
  00000001            00022 testvalid EQU 1
                      00023 #define TESTVALID PORTA,testvalid
                      00024 
  00000003            00025 ttest equ 3
                      00026 #define TTEST PORTA,ttest
                      00027 
  00000004            00028 tnext equ 4
                      00029 #define TNEXT PORTA,tnext
                      00030 
                      00031 ; ------------ Relaisouts ------------
                      00032 ;----
  00000005            00033 rel0 EQU 5
                      00034 #define REL0 PORTA,rel0
                      00035 
  00000000            00036 rel1 EQU 0
                      00037 #define REL1 PORTE,rel1
                      00038 
  00000001            00039 rel2 EQU 1
                      00040 #define REL2 PORTE,rel2
                      00041 
  00000002            00042 rel3 EQU 2
                      00043 #define REL3 PORTE,rel3
                      00044 
  00000000            00045 rel4 EQU 0
                      00046 #define REL4 PORTC,rel4
                      00047 
  00000001            00048 rel5 EQU 1
                      00049 #define REL5 PORTC,rel5
                      00050 
  00000001            00051 rel6 EQU 1
                      00052 #define REL6 PORTD,rel6
                      00053 
  00000000            00054 rel7 EQU 0
                      00055 #define REL7 PORTD,rel7
                      00056 
  00000003            00057 rel8 EQU 3
                      00058 #define REL8 PORTC,rel8
                      00059 
  00000002            00060 rel9 EQU 2
                      00061 #define REL9 PORTC,rel9
                      00062 
  00000002            00063 rel10 EQU 2
                      00064 #define REL10 PORTD,rel10
                      00065 
  00000003            00066 rel11 EQU 3
                      00067 #define REL11 PORTD,rel11
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  3
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00068 
  00000004            00069 rel12 EQU 4
                      00070 #define REL12 PORTC,rel12
                      00071 
  00000005            00072 rel13 EQU 5
                      00073 #define REL13 PORTC,rel13
                      00074 
  00000004            00075 rel14 EQU 4
                      00076 #define REL14 PORTD,rel14
                      00077 
  00000005            00078 rel15 EQU 5
                      00079 #define REL15 PORTD,rel15
                      00080 
  00000006            00081 rel16 EQU 6
                      00082 #define REL16 PORTD,rel16
                      00083 
  00000007            00084 rel17 EQU 7
                      00085 #define REL17 PORTD,rel17
                      00086 
  00000000            00087 rel18 EQU 0
                      00088 #define REL18 PORTB,rel18
                      00089 
  00000001            00090 rel19 EQU 1
                      00091 #define REL19 PORTB,rel19
                      00092 
  00000002            00093 rel20 EQU 2
                      00094 #define REL20 PORTB,rel20
                      00095 
  00000003            00096 rel21 EQU 3
                      00097 #define REL21 PORTB,rel21
                      00098 
  00000004            00099 rel22 EQU 4
                      00100 #define REL22 PORTB,rel22
                      00101 
  00000005            00102 rel23 EQU 5
                      00103 #define REL23 PORTB,rel23
                      00036 
                      00037 ; 3.)  Variablen and #defines
                      00038 
                      00039     include defines.inc
                      00001 ; algo 2003
                      00002 ; DEFINITIONS and PARAMETER
                      00003 
                      00004 ;minimale Velocity
                      00005 #define MINIMUM_VEL 5
                      00006 
                      00007 ; -- Timer setup ---
                      00008 
                      00009 ; delaycycles = (t*f/4)/2 = t * 20 * 10^6Hz/8 = t* 2,5 * 10^6 Hz
                      00010 ; delaycyles = (1/20 10^3Hz)* 2500 * 10^3 = 2500/20 = 125
                      00011 ; Prescaler 2 -> 125/0 = 125
                      00012 ; Load 256 - 125 = 100 (real 109 ???)
                      00013 ; 5MHz/(4*10) = ca. 100 kHz
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  4
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00014 
                      00015 ; ----------- 100 microseconds interrupt
                      00016 ;#define USE_NPSA     (1 << PSA)  ; 20Khz
                      00017 #define USE_NPSA     (0) 
                      00018 #define PRE_SCALE    B'000'      ; 
                      00019 #define TMR0_LOAD    (256 - 241) ; experimentell festgestellt.
                      00020 #define PRE_COUNT  (4) ; erste decrement
                      00021 
                      00022 ; ---------- 50 microseconds  interrupt ----------
                      00023 ;#define USE_NPSA     (1 << PSA)  ; 20Khz
                      00024 ;;#define USE_NPSA     (0) 
                      00025 ;#define PRE_SCALE    B'000'      ; 
                      00026 ;#define TMR0_LOAD    (256 - 235) ; experimentell festgestellt.
                      00027 ;#define PRE_COUNT  (4) ; erste decrement
                      00028 
                      00029 ; ---------- NOTEN --------------
                      00030 
                      00031 ;notenstatus 
  00000000            00032 n_onbit    equ 0    
  00000001            00033 n_pulsbit  equ 1 ; whärend des anschlags (sonst haltephase)
                      00034                  ; nicht mehr verwendet da nicht notwendig
  00000002            00035 n_neubit   equ 2 ; neuer anschlag
  00000003            00036 n_haltebit equ 3 ; gesetzt wenn on und halte (fast interrupt)
  00000004            00037 n_syncbit  equ 4 ; im synchronmodus synchronspiel
                      00038 
                      00039 ; Livestatus
                      00040 
  00000000            00041 livebit equ 0
                      00042 #define  LIVEBIT systemstatus,livebit
                      00043 
                      00044 ; ---------- Serial in
  00000007            00045 status_bit equ 7
                      00046 #define STATUS_BIT addresse,status_bit
                      00047 
  00000004            00048 addr1_bit equ 4
                      00049 #define ADDR1_BIT addresse,addr1_bit
  00000005            00050 addr2_bit equ 5
                      00051 #define ADDR2_BIT addresse,addr2_bit
  00000006            00052 addr3_bit equ 6
                      00053 #define ADDR3_BIT addresse,addr3_bit
                      00054 
                      00055 ;#define ADDR_MASK B'01110000'
                      00056 #define ADDR_MASK (1<<addr1_bit)|(1<<addr2_bit)|(1<<addr3_bit)
                      00057 #define VALIDMASK (ADDR_MASK | (1 << status_bit))
                      00058 #define NOTENNRMASK B'00001111'
                      00059 
  00000001            00060 datavalid equ 1
                      00061 #define  DATAVALID systemstatus,datavalid
  00000002            00062 datawait  equ 2
                      00063 #define  DATAWAIT  systemstatus,datawait
                      00064 
                      00065 ; --- Debug out on RA1, RA2 (jumper für adresse) 
                      00066     
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  5
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000001            00067 debugpin EQU 1
                      00068 #define  DEBUGPORT  PORTA
                      00069 #define  DEBUGPIN  DEBUGPORT, debugpin
                      00070 
  00000002            00071 debugpin1 EQU 2
                      00072 #define  DEBUGPORT1 PORTA
                      00073 #define  DEBUGPIN1  DEBUGPORT1, debugpin1
                      00074 
                      00075 ;#define  DEBUGTRIS ~((1 << debugpin) | (1 << debugpin1))
                      00076 ;#define  DEBUGTRIS ~(1 << debugpin)
                      00077 ;#define  DEBUGTRIS ~(1 << debugpin1)
                      00078 #define  DEBUGTRIS ~(0) ; DEBUG off
                      00079 
                      00080 #define SDEBUGPIN
                      00081 #define CDEBUGPIN
                      00082 #define SDEBUGPIN1
                      00083 #define CDEBUGPIN1
                      00084 
                      00085 ;#define SDEBUGPIN  bsf DEBUGPIN
                      00086 ;#define CDEBUGPIN  bcf DEBUGPIN
                      00087 ;#define SDEBUGPIN1 bsf DEBUGPIN1
                      00088 ;#define CDEBUGPIN1 bcf DEBUGPIN1
                      00089 
                      00090 
                      00040     include macros.inc
                      00001 ; Autoklavierspieler für relais
                      00002 ;  MACROS
                      00003 
                      00004 ; ------------ in interrupt haltepuls spielen ---------
                      00005 
                      00006 halte_note macro note, index2
                      00007   movlw  index2
                      00008   btfss  note, n_haltebit
                      00009   goto   $+6     ; nicht haltemode next
                      00010   btfsc  haltepuls0,haltebit  ; 2+ Befehle
                      00011   goto   $+3
                      00012   call   ClearPort2           ; 4 befehle
                      00013   goto   $+2
                      00014   call   SetPort2             ; 4 Befehle
                      00015  endm                         ; = 6
                      00016 
                      00017 ; ---------- Noten spielen ---------
                      00018 play_note macro note, puls, index
                      00019 
                      00020         movlw   index            ; 1 relais 1
                      00021    
                      00022         btfss   note, n_onbit    ; 2 note ein ?
                      00023         goto    $+8              ; 3 pnoteneu -> nein weiter
                      00024 
                      00025     decfsz  puls, f          ; 4 decrement anschlag
                      00026     goto    $+11             ; 5 pnoteend   
                      00027 
                      00028     bcf    note, n_onbit     ; 6
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  6
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00029 
                      00030     call    SetPort2         ; 7 Haltebuz on
                      00031         addlw   2                ; 8 next relais
                      00032     call    ClearPort2       ; 9 Attack off
                      00033     
                      00034     ; set note +1
                      00035 
                      00036     goto   $+7 ; pnoteend    ; 10
                      00037 
                      00038 ;pnoteneu
                      00039     btfss  note, n_neubit    ; 11
                      00040     goto   $+5 ; pnoteend    ; 12
                      00041 
                      00042     bsf    note, n_onbit     ; 13
                      00043     bcf    note, n_neubit    ; 14
                      00044 
                      00045         addlw   2                ; 15 next relais
                      00046 
                      00047     call   SetPort2          ; 16
                      00048 ; pnoteend
                      00049     endm                     ; min 3 max 9
                      00050 
                      00051 ; ------------- tasten indizierung
                      00052 
                      00053 tastenr_to_fsr macro Var
                      00054         movfw   tastennr
                      00055     movwf   FSR
                      00056         decf    FSR, f          ; 1-24 -> 0-23
                      00057     bcf     STATUS,C        ; * 2
                      00058     rlf     FSR, f
                      00059     movlw   LOW Var         ; Puls0 adresse 
                      00060         addwf   FSR, f          ; hinzuaddieren
                      00061     endm
                      00062 
                      00063 w_to_fsr macro Var
                      00064     movwf   FSR
                      00065 ;       decf    FSR, f          ; 0-23
                      00066     bcf     STATUS,C        ; * 2
                      00067     rlf     FSR, f
                      00068     movlw   LOW Var         ; Puls0 adresse 
                      00069         addwf   FSR, f          ; hinzuaddieren
                      00070     endm
                      00071 
                      00072 
                      00073 ; ------------- Interrupt helps
                      00074 
                      00075 ;       DISABLE_IRQ disable global irq 
                      00076 
                      00077 disable_irq MACRO
                      00078         LOCAL   stop_int
                      00079 stop_int        BCF     INTCON,GIE          ; disable global interrupt
                      00080                         BTFSC   INTCON,GIE      ; check if disabled 
                      00081                         GOTO    stop_int        ; nope, try again
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  7
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00082         ENDM
                      00083         
                      00084 
                      00085 ;       ENABLE_IRQ enable global irq 
                      00086 
                      00087 enable_irq MACRO
                      00088         BSF     INTCON,GIE      ; enable global interrupt
                      00089         ENDM
                      00041     include variable.inc
                      00001 ;
                      00002 ; (c) ALGO 2003
                      00003 ; 
                      00004 ; Variablendefinition Autoklavier
                      00005 
                      00006 ; Statusbits für programm
                      00007   #define STEST schalter,0  ; Bit 0 Schalter TEST
                      00008   #define SNEXT schalter,1  ; Bit 1 Schalter NEXT
                      00009 
                      00010   #define DAUERTEST schalter,4 ; relais dauertest
                      00011   #define haltebit 0
                      00012 
                      00013       CBLOCK 0x20
                      00014 
                      00015   ; 4  interrupt saving register
  00000020            00016         _w, _status       
  00000022            00017         _fsr, _pclath
                      00018 
                      00019   ; 8 ---- tasteninterface 
  00000024            00020     tastennr    ; Nr der aktuellen Taste
  00000025            00021     schalter    ; Test Taste bitfeld
  00000026            00022     poti        ; potiwert
                      00023     
                      00024   ; 9 ----  Helpers 
  00000027            00025     relaisnr    ; Index fuer set/clear port
  00000028            00026     nindex      ; wo noten gezaehlt werden...              
                      00027  ;  12 timer vars
                      00028 
  00000029            00029     precount
  0000002A            00030     timecount0  ; count timer interrupts
  0000002B            00031         timecount1      ; 16Bit high 
                      00032 
                      00033 ; 16 haltepuls
                      00034 ;    hindex       ; index haltepuls
                      00035 ;    haltepuls0   ; haltpulshifter 
                      00036 ;    haltepuls1   ; 16 Bit
                      00037 ;    haltepuls2   ; 24 Bit
                      00038 
                      00039 ; 17 systemstatus
                      00040 
  0000002C            00041     systemstatus  ; livebit, datavalid
  0000002D            00042     addresse      ; Adresse
                      00043 
                      00044 ; 19 rs232
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  8
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00045    
  0000002E            00046   inbyte ; empfangenes datum
  0000002F            00047   notenr ; aktuelle  notenr
  00000030            00048   velo   ; velocity der note
                      00049 
                      00050 ; + 48 = 56 noten
                      00051 
  00000031            00052     puls0         ; anschlag 
  00000032            00053     note0         ; status für note siehe defines for bits
  00000033            00054     puls1         ; anschlag 
  00000034            00055     note1         ; status für note siehe defines for bits
  00000035            00056     puls2         ; anschlag 
  00000036            00057     note2         ; status für note siehe defines for bits
  00000037            00058     puls3         ; anschlag 
  00000038            00059     note3         ; status für note siehe defines for bits
  00000039            00060     puls4         ; anschlag 
  0000003A            00061     note4         ; status für note siehe defines for bits
  0000003B            00062     puls5         ; anschlag 
  0000003C            00063     note5         ; status für note siehe defines for bits
  0000003D            00064     puls6        ; anschlag 
  0000003E            00065     note6         ; status für note siehe defines for bits
  0000003F            00066     puls7         ; anschlag 
  00000040            00067     note7         ; status für note siehe defines for bits
  00000041            00068     puls8         ; anschlag 
  00000042            00069     note8         ; status für note siehe defines for bits
  00000043            00070     puls9         ; anschlag 
  00000044            00071     note9         ; status für note siehe defines for bits
  00000045            00072     puls10         ; anschlag 
  00000046            00073     note10         ; status für note siehe defines for bits
  00000047            00074     puls11         ; anschlag 
  00000048            00075     note11         ; status für note siehe defines for bits
                      00076 ;    puls12         ; anschlag 
                      00077 ;    note12         ; status für note siehe defines for bits
                      00078 ;    puls13         ; anschlag 
                      00079 ;    note13         ; status für note siehe defines for bits
                      00080 ;    puls14         ; anschlag 
                      00081 ;    note14         ; status für note siehe defines for bits
                      00082 ;    puls15         ; anschlag 
                      00083 ;    note15         ; status für note siehe defines for bits
                      00084 ;    puls16        ; anschlag 
                      00085 ;    note16         ; status für note siehe defines for bits
                      00086 ;    puls17         ; anschlag 
                      00087 ;    note17         ; status für note siehe defines for bits
                      00088 ;    puls18         ; anschlag 
                      00089 ;    note18         ; status für note siehe defines for bits
                      00090 ;    puls19         ; anschlag 
                      00091 ;    note19         ; status für note siehe defines for bits
                      00092 ;    puls20         ; anschlag 
                      00093 ;    note20         ; status für note siehe defines for bits
                      00094 ;    puls21         ; anschlag 
                      00095 ;    note21         ; status für note siehe defines for bits
                      00096 ;    puls22         ; anschlag 
                      00097 ;    note22         ; status für note siehe defines for bits
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE  9
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00098 ;    puls23         ; anschlag 
                      00099 ;    note23         ; status für note siehe defines for bits
                      00100 
                      00101         endc
                      00102 
                      00103 
                      00042    
                      00043 
                      00044 ; 4) RESET und Interrupt Code
                      00045 
0000                  00046         org 0x000
0000                  00047 RESET                   ; start at reset vector
0000   0000           00048         NOP                 ; for debugger
0001   0183           00049     clrf STATUS ; ensure to be bank 0
0002   018A           00050     clrf PCLATH ; ensure no page bits set (before goto)
0003   298D           00051         goto Start
                      00052 
0004                  00053         org 0x004               ; --- Interrupt service routine
0004   286B           00054         goto Int
                      00055 
                      00056     include "relaytab.inc" ; muss innerhalb einer org 0xFF sein
                      00001 ; 5 Befehle fuer table lookup und und setport
                      00002 ; w ist index
0005                  00003 ClearPort
0005   1003           00004     bcf   STATUS,C
0006   0D27           00005     rlf   relaisnr, w  ; *2 als index nach w
0007                  00006 ClearPort2          ; wenn index schon * 2 ist dann nur 3 befehle
0007   0782           00007     addwf PCL, f
                      00008 
0008   1685           00009     bsf REL0
0009   0008           00010     return
                      00011 
000A   1409           00012     bsf REL1
000B   0008           00013     return
                      00014 
000C   1489           00015     bsf REL2
000D   0008           00016     return
                      00017 
000E   1509           00018     bsf REL3
000F   0008           00019     return
                      00020 
0010   1407           00021     bsf REL4
0011   0008           00022     return
                      00023 
0012   1487           00024     bsf REL5
0013   0008           00025     return
                      00026 
0014   1488           00027     bsf REL6
0015   0008           00028     return
                      00029 
0016   1408           00030     bsf REL7
0017   0008           00031     return
                      00032 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 10
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0018   1587           00033     bsf REL8
0019   0008           00034     return
                      00035 
001A   1507           00036     bsf REL9
001B   0008           00037     return
                      00038 
001C   1508           00039     bsf REL10
001D   0008           00040     return
                      00041 
001E   1588           00042     bsf REL11
001F   0008           00043     return
                      00044 
0020   1607           00045     bsf REL12
0021   0008           00046     return
                      00047 
0022   1687           00048     bsf REL13
0023   0008           00049     return
                      00050 
0024   1608           00051     bsf REL14
0025   0008           00052     return
                      00053 
0026   1688           00054     bsf REL15
0027   0008           00055     return
                      00056 
0028   1708           00057     bsf REL16
0029   0008           00058     return
                      00059 
002A   1788           00060     bsf REL17
002B   0008           00061     return
                      00062 
002C   1406           00063     bsf REL18
002D   0008           00064     return
                      00065 
002E   1486           00066     bsf REL19
002F   0008           00067     return
                      00068 
0030   1506           00069     bsf REL20
0031   0008           00070     return
                      00071 
0032   1586           00072     bsf REL21
0033   0008           00073     return
                      00074 
0034   1606           00075     bsf REL22
0035   0008           00076     return
                      00077 
0036   1686           00078     bsf REL23
0037   0008           00079     return
                      00080 
                      00081 
                      00082 ; 5 Befehle fuer table lookup und und clear port
                      00083 ; w ist index
0038                  00084 SetPort
0038   1003           00085     bcf   STATUS,C
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 11
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0039   0D27           00086     rlf   relaisnr, w  ; *2 als index nach w
003A                  00087 SetPort2          ; wenn index schon * 2 ist dann nur 3 befehle
003A   0782           00088     addwf PCL, f
                      00089 
003B   1285           00090     bcf REL0
003C   0008           00091     return
                      00092 
003D   1009           00093     bcf REL1
003E   0008           00094     return
                      00095 
003F   1089           00096     bcf REL2
0040   0008           00097     return
                      00098 
0041   1109           00099     bcf REL3
0042   0008           00100     return
                      00101 
0043   1007           00102     bcf REL4
0044   0008           00103     return
                      00104 
0045   1087           00105     bcf REL5
0046   0008           00106     return
                      00107 
0047   1088           00108     bcf REL6
0048   0008           00109     return
                      00110 
0049   1008           00111     bcf REL7
004A   0008           00112     return
                      00113 
004B   1187           00114     bcf REL8
004C   0008           00115     return
                      00116 
004D   1107           00117     bcf REL9
004E   0008           00118     return
                      00119 
004F   1108           00120     bcf REL10
0050   0008           00121     return
                      00122 
0051   1188           00123     bcf REL11
0052   0008           00124     return
                      00125 
0053   1207           00126     bcf REL12
0054   0008           00127     return
                      00128 
0055   1287           00129     bcf REL13
0056   0008           00130     return
                      00131 
0057   1208           00132     bcf REL14
0058   0008           00133     return
                      00134 
0059   1288           00135     bcf REL15
005A   0008           00136     return
                      00137 
005B   1308           00138     bcf REL16
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 12
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

005C   0008           00139     return
                      00140 
005D   1388           00141     bcf REL17
005E   0008           00142     return
                      00143 
005F   1006           00144     bcf REL18
0060   0008           00145     return
                      00146 
0061   1086           00147     bcf REL19
0062   0008           00148     return
                      00149 
0063   1106           00150     bcf REL20
0064   0008           00151     return
                      00152 
0065   1186           00153     bcf REL21
0066   0008           00154     return
                      00155 
0067   1206           00156     bcf REL22
0068   0008           00157     return
                      00158 
0069   1286           00159     bcf REL23
006A   0008           00160     return
                      00057 
                      00058 ; v2 not needed  include "haltetab.inc" ; muss innerhalb einer org 0xFF sein
                      00059 
                      00060     include "intimer.inc"
                      00001 ; autoklavier
                      00002 ; algo 2003
                      00003 ; now adapted for 2004
                      00004 
                      00005 ; ----- INTERRUPT ---------
006B                  00006 Int
006B   00A0           00007         movwf  _w                ; -- Save the Context Registers
006C   0803           00008         movf   STATUS, w
006D   1283           00009         bcf    STATUS, RP0       ;  Change to Bank 0
006E   1303           00010         bcf    STATUS, RP1
006F   00A1           00011         movwf  _status
0070   0804           00012         movf   FSR, w
0071   00A2           00013         movwf  _fsr
                      00014 ;       movf   PCLATH, w        ; only need if code > 1 Page (2048)
                      00015 ;       movwf  _pclath          
                      00016 ;       clrf   PCLATH
                      00017 
                      00018 
                      00019 
                      00020 ; --------- interrupt dispatcher ---------------
                      00021 ; --- first serial interrupt, because its more often
                      00022 
0072                  00023 int_serial_rx
0072   1E8C           00024         btfss   PIR1,RCIF       ; test if serial receive irq
0073   2875           00025     goto    int_timer   ; nope check next
                      00026 
                      00027 ; ----------- rx irq ------------------------------
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 13
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0074   2195           00028         call SerialIn
                      00029 
                      00030 ; ----------- Timer Intterrupt --------------------
                      00031 
0075                  00032 int_timer
0075   1D0B           00033         btfss   INTCON, T0IF ; do we have a Timer Interrupt
0076   2945           00034         goto    IntEnd           ; no -> EndofInt
                      00035 
0077   110B           00036         bcf     INTCON, T0IF     ; Timer-Int register clear
0078   300F           00037         movlw   TMR0_LOAD        ; start timer again
0079   0081           00038         movwf   TMR0
                      00039 
                      00040 ; ---- debug out on REL0 ist 20MHz takt ---
                      00041         SDEBUGPIN
                      00042 
                      00043 ; --------- Zeit --------------
                      00044 ;  bei 20Khz timer :
                      00045 ;  1000/4 = 256 Befehle max !!!!
                      00046 ;  main programm:  noch 10 befehle bei 20Khz + interrupt -> 240
                      00047 ;  10 pro note
                      00048 
                      00049 ; ------- do haltepuls - old now secon relais
                      00050 ;   bcf   STATUS, C             ;  5-6
                      00051 ;   btfsc  haltepuls2, 7
                      00052 ;   bsf   STATUS, C
                      00053 ;   rlf    haltepuls0, f
                      00054 ;   rlf    haltepuls1, f
                      00055 ;   rlf    haltepuls2, f
                      00056 ;
                      00057 
                      00058 ; ---- debug ausgang
                      00059 ;   btfsc  puls0, n_onbit  ; 3 Befehle
                      00060 ;   goto   $+3
                      00061 ;   bcf    DEBUGPIN1
                      00062 ;   goto   $+2
                      00063 ;   bsf    DEBUGPIN1
                      00064 
                      00065 ; ------------ FAST LOOP ---------------
                      00066 ; -------------- noten halten ----------
                      00067 
                      00068 ;   halte_note note0, 0
                      00069 ;   halte_note note1, 2
                      00070 ;   halte_note note2, 4
                      00071 ;   halte_note note3, 6
                      00072 ;   halte_note note4, 8
                      00073 ;   halte_note note5, 10
                      00074 ;   halte_note note6, 12
                      00075 ;   halte_note note7, 14
                      00076 ;   halte_note note8, 16
                      00077 ;   halte_note note9, 18
                      00078 ;   halte_note note10, 20
                      00079 ;   halte_note note11, 22
                      00080 ;   halte_note note12, 24
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 14
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00081 ;   halte_note note13, 26
                      00082 ;   halte_note note14, 28
                      00083 ;   halte_note note15, 30
                      00084 ;   halte_note note16, 32
                      00085 ;   halte_note note17, 34
                      00086 ;   halte_note note18, 36
                      00087 ;   halte_note note19, 38
                      00088 ;   halte_note note20, 40
                      00089 ;   halte_note note21, 42
                      00090 ;   halte_note note22, 44
                      00091 ;   halte_note note23, 46
                      00092 ; 
                      00093 ; ----------------- Prescale -----------------
007A                  00094 pre_tick        ; / 8 => 0.4ms
007A   0BA9           00095   decfsz        precount, f     ; count timer
007B   2945           00096   goto time_end         ; notreached -> end
                      00097 
007C   3004           00098   movlw   PRE_COUNT   
007D   00A9           00099   movwf   precount  
                      00100 ; ----------------------------------------
                      00101 
                      00102 ; --------------- note spielen ------------------------
                      00103 ; ein -> setze pulswert und dann n_neubit
                      00104 ; aus -> loesche n_onbit
                      00105      play_note note0, puls0, 0
                          M 
007E   3000               M         movlw   0                ; 1 relais 1
                          M    
007F   1C32               M         btfss   note0, n_onbit   ; 2 note ein ?
0080   2888               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
0081   0BB1               M     decfsz  puls0, f         ; 4 decrement anschlag
0082   288D               M     goto    $+11             ; 5 pnoteend   
                          M 
0083   1032               M     bcf    note0, n_onbit    ; 6
                          M 
0084   203A               M     call    SetPort2         ; 7 Haltebuz on
0085   3E02               M         addlw   2                ; 8 next relais
0086   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
0087   288E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0088   1D32               M     btfss  note0, n_neubit   ; 11
0089   288E               M     goto   $+5 ; pnoteend    ; 12
                          M 
008A   1432               M     bsf    note0, n_onbit    ; 13
008B   1132               M     bcf    note0, n_neubit   ; 14
                          M 
008C   3E02               M         addlw   2                ; 15 next relais
                          M 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 15
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

008D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00106      play_note note1, puls1, 4
                          M 
008E   3004               M         movlw   4                ; 1 relais 1
                          M    
008F   1C34               M         btfss   note1, n_onbit   ; 2 note ein ?
0090   2898               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
0091   0BB3               M     decfsz  puls1, f         ; 4 decrement anschlag
0092   289D               M     goto    $+11             ; 5 pnoteend   
                          M 
0093   1034               M     bcf    note1, n_onbit    ; 6
                          M 
0094   203A               M     call    SetPort2         ; 7 Haltebuz on
0095   3E02               M         addlw   2                ; 8 next relais
0096   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
0097   289E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0098   1D34               M     btfss  note1, n_neubit   ; 11
0099   289E               M     goto   $+5 ; pnoteend    ; 12
                          M 
009A   1434               M     bsf    note1, n_onbit    ; 13
009B   1134               M     bcf    note1, n_neubit   ; 14
                          M 
009C   3E02               M         addlw   2                ; 15 next relais
                          M 
009D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00107      play_note note2, puls2, 8
                          M 
009E   3008               M         movlw   8                ; 1 relais 1
                          M    
009F   1C36               M         btfss   note2, n_onbit   ; 2 note ein ?
00A0   28A8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00A1   0BB5               M     decfsz  puls2, f         ; 4 decrement anschlag
00A2   28AD               M     goto    $+11             ; 5 pnoteend   
                          M 
00A3   1036               M     bcf    note2, n_onbit    ; 6
                          M 
00A4   203A               M     call    SetPort2         ; 7 Haltebuz on
00A5   3E02               M         addlw   2                ; 8 next relais
00A6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00A7   28AE               M     goto   $+7 ; pnoteend    ; 10
                          M 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 16
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M ;pnoteneu
00A8   1D36               M     btfss  note2, n_neubit   ; 11
00A9   28AE               M     goto   $+5 ; pnoteend    ; 12
                          M 
00AA   1436               M     bsf    note2, n_onbit    ; 13
00AB   1136               M     bcf    note2, n_neubit   ; 14
                          M 
00AC   3E02               M         addlw   2                ; 15 next relais
                          M 
00AD   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00108      play_note note3, puls3, 12
                          M 
00AE   300C               M         movlw   12               ; 1 relais 1
                          M    
00AF   1C38               M         btfss   note3, n_onbit   ; 2 note ein ?
00B0   28B8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00B1   0BB7               M     decfsz  puls3, f         ; 4 decrement anschlag
00B2   28BD               M     goto    $+11             ; 5 pnoteend   
                          M 
00B3   1038               M     bcf    note3, n_onbit    ; 6
                          M 
00B4   203A               M     call    SetPort2         ; 7 Haltebuz on
00B5   3E02               M         addlw   2                ; 8 next relais
00B6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00B7   28BE               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
00B8   1D38               M     btfss  note3, n_neubit   ; 11
00B9   28BE               M     goto   $+5 ; pnoteend    ; 12
                          M 
00BA   1438               M     bsf    note3, n_onbit    ; 13
00BB   1138               M     bcf    note3, n_neubit   ; 14
                          M 
00BC   3E02               M         addlw   2                ; 15 next relais
                          M 
00BD   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00109      play_note note4, puls4, 16
                          M 
00BE   3010               M         movlw   16               ; 1 relais 1
                          M    
00BF   1C3A               M         btfss   note4, n_onbit   ; 2 note ein ?
00C0   28C8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00C1   0BB9               M     decfsz  puls4, f         ; 4 decrement anschlag
00C2   28CD               M     goto    $+11             ; 5 pnoteend   
                          M 
00C3   103A               M     bcf    note4, n_onbit    ; 6
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 17
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M 
00C4   203A               M     call    SetPort2         ; 7 Haltebuz on
00C5   3E02               M         addlw   2                ; 8 next relais
00C6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00C7   28CE               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
00C8   1D3A               M     btfss  note4, n_neubit   ; 11
00C9   28CE               M     goto   $+5 ; pnoteend    ; 12
                          M 
00CA   143A               M     bsf    note4, n_onbit    ; 13
00CB   113A               M     bcf    note4, n_neubit   ; 14
                          M 
00CC   3E02               M         addlw   2                ; 15 next relais
                          M 
00CD   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00110      play_note note5, puls5, 20
                          M 
00CE   3014               M         movlw   20               ; 1 relais 1
                          M    
00CF   1C3C               M         btfss   note5, n_onbit   ; 2 note ein ?
00D0   28D8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00D1   0BBB               M     decfsz  puls5, f         ; 4 decrement anschlag
00D2   28DD               M     goto    $+11             ; 5 pnoteend   
                          M 
00D3   103C               M     bcf    note5, n_onbit    ; 6
                          M 
00D4   203A               M     call    SetPort2         ; 7 Haltebuz on
00D5   3E02               M         addlw   2                ; 8 next relais
00D6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00D7   28DE               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
00D8   1D3C               M     btfss  note5, n_neubit   ; 11
00D9   28DE               M     goto   $+5 ; pnoteend    ; 12
                          M 
00DA   143C               M     bsf    note5, n_onbit    ; 13
00DB   113C               M     bcf    note5, n_neubit   ; 14
                          M 
00DC   3E02               M         addlw   2                ; 15 next relais
                          M 
00DD   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00111      play_note note6, puls6, 24
                          M 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 18
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00DE   3018               M         movlw   24               ; 1 relais 1
                          M    
00DF   1C3E               M         btfss   note6, n_onbit   ; 2 note ein ?
00E0   28E8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00E1   0BBD               M     decfsz  puls6, f         ; 4 decrement anschlag
00E2   28ED               M     goto    $+11             ; 5 pnoteend   
                          M 
00E3   103E               M     bcf    note6, n_onbit    ; 6
                          M 
00E4   203A               M     call    SetPort2         ; 7 Haltebuz on
00E5   3E02               M         addlw   2                ; 8 next relais
00E6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00E7   28EE               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
00E8   1D3E               M     btfss  note6, n_neubit   ; 11
00E9   28EE               M     goto   $+5 ; pnoteend    ; 12
                          M 
00EA   143E               M     bsf    note6, n_onbit    ; 13
00EB   113E               M     bcf    note6, n_neubit   ; 14
                          M 
00EC   3E02               M         addlw   2                ; 15 next relais
                          M 
00ED   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00112      play_note note7, puls7, 28
                          M 
00EE   301C               M         movlw   28               ; 1 relais 1
                          M    
00EF   1C40               M         btfss   note7, n_onbit   ; 2 note ein ?
00F0   28F8               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
00F1   0BBF               M     decfsz  puls7, f         ; 4 decrement anschlag
00F2   28FD               M     goto    $+11             ; 5 pnoteend   
                          M 
00F3   1040               M     bcf    note7, n_onbit    ; 6
                          M 
00F4   203A               M     call    SetPort2         ; 7 Haltebuz on
00F5   3E02               M         addlw   2                ; 8 next relais
00F6   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
00F7   28FE               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
00F8   1D40               M     btfss  note7, n_neubit   ; 11
00F9   28FE               M     goto   $+5 ; pnoteend    ; 12
                          M 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 19
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00FA   1440               M     bsf    note7, n_onbit    ; 13
00FB   1140               M     bcf    note7, n_neubit   ; 14
                          M 
00FC   3E02               M         addlw   2                ; 15 next relais
                          M 
00FD   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00113      play_note note8, puls8, 32
                          M 
00FE   3020               M         movlw   32               ; 1 relais 1
                          M    
00FF   1C42               M         btfss   note8, n_onbit   ; 2 note ein ?
0100   2908               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
0101   0BC1               M     decfsz  puls8, f         ; 4 decrement anschlag
0102   290D               M     goto    $+11             ; 5 pnoteend   
                          M 
0103   1042               M     bcf    note8, n_onbit    ; 6
                          M 
0104   203A               M     call    SetPort2         ; 7 Haltebuz on
0105   3E02               M         addlw   2                ; 8 next relais
0106   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
0107   290E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0108   1D42               M     btfss  note8, n_neubit   ; 11
0109   290E               M     goto   $+5 ; pnoteend    ; 12
                          M 
010A   1442               M     bsf    note8, n_onbit    ; 13
010B   1142               M     bcf    note8, n_neubit   ; 14
                          M 
010C   3E02               M         addlw   2                ; 15 next relais
                          M 
010D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00114      play_note note9, puls9, 36
                          M 
010E   3024               M         movlw   36               ; 1 relais 1
                          M    
010F   1C44               M         btfss   note9, n_onbit   ; 2 note ein ?
0110   2918               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
0111   0BC3               M     decfsz  puls9, f         ; 4 decrement anschlag
0112   291D               M     goto    $+11             ; 5 pnoteend   
                          M 
0113   1044               M     bcf    note9, n_onbit    ; 6
                          M 
0114   203A               M     call    SetPort2         ; 7 Haltebuz on
0115   3E02               M         addlw   2                ; 8 next relais
0116   2007               M     call    ClearPort2       ; 9 Attack off
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 20
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M     
                          M     ; set note +1
                          M 
0117   291E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0118   1D44               M     btfss  note9, n_neubit   ; 11
0119   291E               M     goto   $+5 ; pnoteend    ; 12
                          M 
011A   1444               M     bsf    note9, n_onbit    ; 13
011B   1144               M     bcf    note9, n_neubit   ; 14
                          M 
011C   3E02               M         addlw   2                ; 15 next relais
                          M 
011D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00115      play_note note10, puls10, 40
                          M 
011E   3028               M         movlw   40               ; 1 relais 1
                          M    
011F   1C46               M         btfss   note10, n_onbit  ; 2 note ein ?
0120   2928               M         goto    $+8              ; 3 pnoteneu -> nein weiter
                          M 
0121   0BC5               M     decfsz  puls10, f        ; 4 decrement anschlag
0122   292D               M     goto    $+11             ; 5 pnoteend   
                          M 
0123   1046               M     bcf    note10, n_onbit   ; 6
                          M 
0124   203A               M     call    SetPort2         ; 7 Haltebuz on
0125   3E02               M         addlw   2                ; 8 next relais
0126   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
0127   292E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0128   1D46               M     btfss  note10, n_neubit  ; 11
0129   292E               M     goto   $+5 ; pnoteend    ; 12
                          M 
012A   1446               M     bsf    note10, n_onbit   ; 13
012B   1146               M     bcf    note10, n_neubit  ; 14
                          M 
012C   3E02               M         addlw   2                ; 15 next relais
                          M 
012D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00116      play_note note11, puls11, 44
                          M 
012E   302C               M         movlw   44               ; 1 relais 1
                          M    
012F   1C48               M         btfss   note11, n_onbit  ; 2 note ein ?
0130   2938               M         goto    $+8              ; 3 pnoteneu -> nein weiter
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 21
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M 
0131   0BC7               M     decfsz  puls11, f        ; 4 decrement anschlag
0132   293D               M     goto    $+11             ; 5 pnoteend   
                          M 
0133   1048               M     bcf    note11, n_onbit   ; 6
                          M 
0134   203A               M     call    SetPort2         ; 7 Haltebuz on
0135   3E02               M         addlw   2                ; 8 next relais
0136   2007               M     call    ClearPort2       ; 9 Attack off
                          M     
                          M     ; set note +1
                          M 
0137   293E               M     goto   $+7 ; pnoteend    ; 10
                          M 
                          M ;pnoteneu
0138   1D48               M     btfss  note11, n_neubit  ; 11
0139   293E               M     goto   $+5 ; pnoteend    ; 12
                          M 
013A   1448               M     bsf    note11, n_onbit   ; 13
013B   1148               M     bcf    note11, n_neubit  ; 14
                          M 
013C   3E02               M         addlw   2                ; 15 next relais
                          M 
013D   203A               M     call   SetPort2          ; 16
                          M ; pnoteend
                      00117 ;     play_note note12, puls12, 48
                      00118 ;     play_note note13, puls13, 26
                      00119 ;     play_note note14, puls14, 28
                      00120 ;     play_note note15, puls15, 30
                      00121 ;     play_note note16, puls16, 32
                      00122 ;     play_note note17, puls17, 34
                      00123 ;     play_note note18, puls18, 36
                      00124 ;     play_note note19, puls19, 38
                      00125 ;     play_note note20, puls20, 40
                      00126 ;     play_note note21, puls21, 42
                      00127 ;     play_note note22, puls22, 44
                      00128 ;     play_note note23, puls23, 46
                      00129 
                      00130 ;--- timer
013E                  00131 time_tick       ;  0.4ms *256 = 102,4ms
013E   0BAA           00132         decfsz  timecount0, f   ; count timer
013F   2945           00133         goto time_end           ; notreached -> end
                      00134         
                      00135   
                      00136 ; -------------- DEBUG relais 4 dauertest ------------
                      00137 ;    btfss   timecount1,4
                      00138 ;    goto      $+2
                      00139 ;    bcf REL11    
                      00140 ;    btfsc   timecount1,1
                      00141 ;    goto $+2
                      00142 ;    bsf REL11 
                      00143 ; ------------------------------------------------------
                      00144 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 22
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00145 ; ---------- Save off wenn no life bit -----------------
0140                  00146 time_unit       
                      00147 
0140   0BAB           00148         decfsz  timecount1, f ; count timer 102,4ms * 256 = 26,2144 sec
0141   2945           00149         goto time_end             ; notreached -> end
                      00150     ; --- do some --- noteonoffs her
0142   1C2C           00151     btfss LIVEBIT
0143   2234           00152     call all_notes_off
0144   102C           00153     bcf  LIVEBIT
                      00154 ; ------------------------------------------------------
                      00155 
0145                  00156 time_end
                      00157 
                      00158 
0145                  00159 IntEnd                          ; -- Restore the Context Registers
                      00160 ; ---- debug out on REL0 ist 20MHz takt ---
                      00161         CDEBUGPIN1
                      00162 
                      00163 ;       movf   _pclath, w       ; only need if code > 1 Page
                      00164 ;       movwf  PCLATH
0145   0822           00165         movf   _fsr, w
0146   0084           00166         movwf  FSR
0147   0821           00167         movf   _status, w
0148   0083           00168         movwf  STATUS
0149   0EA0           00169         swapf   _w, f
014A   0E20           00170         swapf   _w, w
                      00171 
014B   0009           00172         retfie
                      00173 ;       return
                      00174 
                      00061         include "parser.inc"
                      00001 ; play notes aufgerufen von main oder interrupt:
                      00002 
                      00003 ; --- Parse input which is in w
014C                  00004 parse_input   
                      00005 
014C   00AE           00006     movwf inbyte   ; merken in inbyte
                      00007 
014D   142C           00008     bsf   LIVEBIT  ; mark serial input as alive 
                      00009                    ; (nach 26sec marked dead und weitern 26sec 
                      00010                    ; 'all notes off' in interrupt)
                      00011 
014E   1FAE           00012     btfss inbyte,status_bit ; Status Byte
014F   295F           00013         goto  data_received     ; no -> data_in
                      00014 
0150   10AC           00015     bcf   DATAVALID         ; Data input not valid any more
                      00016  
0151   3970           00017         andlw ADDR_MASK         ; compare address of board
0152   022D           00018         subwf addresse,w
0153   1D03           00019         btfss STATUS,Z
0154   297A           00020         goto parse_end          ; -> not us -> end  
                      00021         
0155   082E           00022     movfw inbyte           ; our note ,
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 23
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0156   390F           00023         andlw NOTENNRMASK      ; mask nummer 
0157   00AF           00024     movwf notenr           ; and remember
0158   3C0B           00025         sublw  11              ; im notenbereich ?
0159   1C03           00026     btfss STATUS,C         ; (if Carry clear result negative !!!)
015A   297A           00027     goto  parse_end        ; negativ -> not a note
                      00028 
015B   1003           00029     bcf     STATUS,C       ; Index = nr * 2
015C   0DAF           00030     rlf     notenr, f      ; fuer vars und SetPort2, ClearPort2
                      00031     
015D   14AC           00032         bsf  DATAVALID         ; naechstes Datum velocity fuer diese note
015E   297A           00033     goto parse_end         ; das wars 
                      00034 
015F                  00035 data_received             ; ------ DATA
015F   1CAC           00036     btfss DATAVALID       ; wir warten auf keine daten
0160   297A           00037     goto parse_end        ; not valid warte auf neues Datum
                      00038 
0161   10AC           00039     bcf   DATAVALID       ; verarbeite datum
                      00040                           
0162   1903           00041     btfsc  STATUS,Z       ; Velocity nicht null 
0163   296F           00042         goto  note_off        ; -> nein note aus
                      00043 
0164                  00044 note_on
0164   3E05           00045     addlw  MINIMUM_VEL   ; Minimum velocity eg.5
0165   00B0           00046     movwf  velo          ; merke velocity
0166   3031           00047     movlw  LOW puls0     ; Puls0 adresse 
0167   0084           00048         movwf  FSR           ; laden
0168   082F           00049     movfw  notenr        ; addiere notenindex  
0169   0784           00050     addwf  FSR,f         ; index 
016A   0830           00051         movfw  velo          ; velo holen
016B   0080           00052     movwf  INDF          ; in den puls = spielen
                      00053 
016C   0A84           00054     incf    FSR, f        ; notenstatus = puls+1
016D   1500           00055     bsf     INDF, n_neubit ; spielen
                      00056 
016E   297A           00057     goto parse_end        ; warte auf neuen status
                      00058 
                      00059 
016F                  00060 note_off                    ; ---------- Note aus
                      00061 
016F   3032           00062     movlw   LOW note0       ; note0 = variablenblock start bei note
0170   0084           00063         movwf   FSR             ; hinzuaddieren
0171   082F           00064     movfw   notenr          ; notenindex (2*nr)
0172   0784           00065     addwf   FSR, f
                      00066 
                      00067 ; bei start mit puls, jedoch unoetig
                      00068 ;    clrf    INDF            ; clrf puls    
                      00069 ;    incf    FSR, f        ; notenstatus = puls+1
                      00070 
0173   0180           00071     clrf    INDF            ; clrf note    
                      00072 
0174   1003           00073     bcf     STATUS,C       ; Index = nr * 2 (gesamt * 4)
0175   0DAF           00074     rlf     notenr, f      ; fuer vars und SetPort2, ClearPort2
                      00075 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 24
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0176   082F           00076     movfw   notenr          ; notennr (= 2*index)
                      00077    
0177   2007           00078     call    ClearPort2      ; Port zturuecksetzen
                      00079 
0178   3E02           00080     addlw   2      ; und haltemoment
0179   2007           00081     call    ClearPort2      ; Port zturuecksetzen
                      00082          
                      00083                             ; falls in high phase 
                      00084     ;;goto parse_end
                      00085 
017A                  00086 parse_end
017A   0008           00087         return
                      00062     include "rs232.inc"
                      00001 ;   RC7 - Serial Receive Pin
                      00002 ;   RC6 - Serial Transmit Pin
                      00003 ;
                      00004 ; Baudrate angeblich SBRG= Fosc/(Rate*16*[4**(1-BRGH)])-1
                      00005 
                      00006 ; Baurate = 20*10^6/(115200 * 16 [4^0]) - 1 = 9,80 -> gewaehlt 10
                      00007 #define BAUD_RATE 10
                      00008 
                      00009 ; baudrate = 20*10^6/(57600 * 16 [4^0]) - 1 = 20,7 -> gewaehlt 21
                      00010 ;#define BAUD_RATE 21
                      00011 
                      00012 ;mit BRGH = 1 (High Speed)
                      00013 
017B                  00014 rs_init 
017B   1683           00015         bsf    STATUS, RP0            ;  Enable the Serial Port
017C   3024           00016         movlw  (1 << TXEN) |(1<<BRGH) ;  Enable Serial Transmission
017D   0098           00017         movwf  TXSTA ^ 0x080          ;  0x26
017E   300A           00018         movlw  BAUD_RATE              ;  Baudrate
017F   0099           00019         movwf  SPBRG ^ 0x080
0180   1283           00020         bcf    STATUS, RP0
0181   3090           00021         movlw  (1 << SPEN) | (1 << CREN) ; 0x90
0182   0098           00022         movwf  RCSTA                  ;  Enable Serial I/O
                      00023 
                      00024     ; IRQ ENABLEN
0183   308C           00025         MOVLW   PIE1    ; get adress for periphial irq's
0184   0084           00026         MOVWF   FSR     ; setup fsr
0185   1680           00027         BSF     INDF,RCIE ; enable reciever irq
0186   170B           00028         BSF     INTCON,PEIE ; and periphial irq must also be enabled
                      00029 
0187   0008           00030         return
                      00031 
                      00032 ;rs_read   ; not used direcxt in code
                      00033 ;       btfss   PIR1, RCIF          ;  Wait for Received Character Set
                      00034 ;       goto    rs_read             ;   - Nothing There
                      00035 ;       movf    RCREG, w            ;  Get the Received Character
                      00036 ;       bcf     PIR1, RCIF          ;  Clear the Character Present Flag
                      00037 ;       return
                      00038 
                      00039 ;rs_write
                      00040 ;       movwf  TXREG                  ;  Send the Character
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 25
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00041 ;       return
                      00042 
                      00043 ; -------------------- Seriell in
0188                  00044 clear_rs                      ; empty seriell buffer in chip
0188   1E8C           00045         btfss   PIR1, RCIF        ;  Wait for Received Character Set
0189   0008           00046     return                    ;   - Nothing There
                      00047 
018A   081A           00048     movfw   RCREG             ;  Get the Received Character
018B   128C           00049     bcf     PIR1, RCIF        ;  Clear the Character Present Flag
018C   2988           00050         goto    clear_rs   
                      00063 
                      00064 ; 5.) Main Code
                      00065 
018D                  00066 Start
018D   21ED           00067         call ports_init
018E   221E           00068     call init_adresse
018F   217B           00069         call rs_init
0190   2188           00070     call clear_rs
                      00071 
                      00072 ; --------  MAIN LOOP if testmode ------
0191                  00073 Loop
                      00074 
                      00075 ;---  call SerialIn   ; Seriellen Eingang abfragen
                      00076 ;---  now a s interrupt
                      00077     
0191   1885           00078         btfsc TESTVALID
0192   2991           00079         goto Loop
                      00080 
0193   21A0           00081     call TestTaste  ; Testtaste, Nexttaste abfragen
0194   2991           00082     goto Loop
                      00083 
                      00084 ; ---------  serint called from interrupt handler
0195                  00085 SerialIn
                      00086 
0195   1E8C           00087         btfss   PIR1, RCIF         ;  Wait for Received Character Set
0196   0008           00088     return                     ;   - Nothing There
                      00089 
0197   081A           00090     movfw   RCREG              ;  Get the Received Character
0198   128C           00091     bcf     PIR1, RCIF         ;  Clear the Character Present Flag
                      00092 
0199   1C98           00093     btfss RCSTA, OERR          ; overrun ??? 
019A   299E           00094         goto  ser_err_end          ; no -> Process Data
                      00095     
019B   1218           00096     bcf  RCSTA, CREN
019C   1618           00097     bsf  RCSTA, CREN
                      00098 
019D   2995           00099         goto SerialIn                           ; if overrun data not valid
                      00100 
019E                  00101 ser_err_end
                      00102 
019E   214C           00103     call parse_input
019F   2995           00104         goto SerialIn               ; run until all processed
                      00105 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 26
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00106 ; -------------------- TestTaste
01A0                  00107 TestTaste
01A0   1D85           00108         btfss   TTEST         ; Testtaste ?
01A1   29A4           00109         goto    TasteTest     ; bedienen
                      00110 
                      00111                           ; Testtaste nicht gedrueckt
01A2   21C4           00112     call    TasteTestOff  ; zuerst ausschalten
01A3   29DE           00113         goto    NextTaste     ; dann NextTaste bearbeiten
                      00114 
01A4                  00115 TasteTest
01A4   1825           00116     btfsc   STEST
01A5   0008           00117     return
                      00118 
                      00119     tastenr_to_fsr note0
01A6   0824               M         movfw   tastennr
01A7   0084               M     movwf   FSR
01A8   0384               M         decf    FSR, f          ; 1-24 -> 0-23
01A9   1003               M     bcf     STATUS,C        ; * 2
01AA   0D84               M     rlf     FSR, f
01AB   3032               M     movlw   LOW note0       ; Puls0 adresse 
01AC   0784               M         addwf   FSR, f          ; hinzuaddieren
01AD   1800           00120     btfsc   INDF, n_onbit    ; note nicht on ?
01AE   0008           00121     return       ; nein -> return ohne STEST setzen damit timeout
                      00122 
                      00123     ; ---------- Wert von poti ---------
                      00124     ; spiele Note
01AF   151F           00125         bsf             ADCON0, GO     ; start adc
01B0   191F           00126         btfsc   ADCON0, GO     ; wait for value
01B1   29B0           00127         goto    $ - 1
01B2   081E           00128     movfw   ADRESH         ; read value
01B3   00A6           00129     movwf   poti
01B4   1003           00130     bcf     STATUS, C
01B5   0CA6           00131     rrf     poti, f
01B6   0AA6           00132     incf    poti, f
                      00133     
                      00134 ; ------- note spielen 
                      00135     tastenr_to_fsr puls0
01B7   0824               M         movfw   tastennr
01B8   0084               M     movwf   FSR
01B9   0384               M         decf    FSR, f          ; 1-24 -> 0-23
01BA   1003               M     bcf     STATUS,C        ; * 2
01BB   0D84               M     rlf     FSR, f
01BC   3031               M     movlw   LOW puls0       ; Puls0 adresse 
01BD   0784               M         addwf   FSR, f          ; hinzuaddieren
                      00136 
01BE   0826           00137         movfw   poti            ; potiwert
01BF   0080           00138     movwf   INDF            ; in den puls
                      00139 
01C0   0A84           00140     incf    FSR, f            ; note = puls+1
01C1   1500           00141     bsf     INDF, n_neubit ; spielen
                      00142 
01C2   1425           00143     bsf     STEST
01C3   0008           00144         return
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 27
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00145 
01C4                  00146 TasteTestOff
01C4   1C25           00147     btfss   STEST
01C5   0008           00148     return
                      00149 
01C6   1025           00150     bcf     STEST
                      00151         ; noteoff
                      00152     tastenr_to_fsr 0
01C7   0824               M         movfw   tastennr
01C8   0084               M     movwf   FSR
01C9   0384               M         decf    FSR, f          ; 1-24 -> 0-23
01CA   1003               M     bcf     STATUS,C        ; * 2
01CB   0D84               M     rlf     FSR, f
01CC   3000               M     movlw   LOW 0           ; Puls0 adresse 
01CD   0784               M         addwf   FSR, f          ; hinzuaddieren
01CE   0804           00153     movfw   FSR
                      00154 
01CF   1003           00155     bcf     STATUS,C       ; Index = nr * 2 (gesamt * 4)
01D0   0DAF           00156     rlf     notenr, f      ; fuer vars und SetPort2, ClearPort2
01D1   2007           00157     call    ClearPort2
01D2   0AAF           00158     incf    notenr, f      ; und haltemoment
01D3   0AAF           00159     incf    notenr, f
01D4   2007           00160     call    ClearPort2     ; Port zturuecksetzen
                      00161 
                      00162     tastenr_to_fsr note0
01D5   0824               M         movfw   tastennr
01D6   0084               M     movwf   FSR
01D7   0384               M         decf    FSR, f          ; 1-24 -> 0-23
01D8   1003               M     bcf     STATUS,C        ; * 2
01D9   0D84               M     rlf     FSR, f
01DA   3032               M     movlw   LOW note0       ; Puls0 adresse 
01DB   0784               M         addwf   FSR, f          ; hinzuaddieren
01DC   0180           00163     clrf    INDF           ; clrf note
                      00164 
01DD   0008           00165         return
                      00166 
                      00167 ; -------------------- nexttaste
01DE                  00168 NextTaste
01DE   1E05           00169         btfss   TNEXT     
01DF   29E1           00170         goto    TasteNext
01E0   29E9           00171     goto    NTasteNext
                      00172 
01E1                  00173 TasteNext
                      00174 
01E1   18A5           00175     btfsc SNEXT
01E2   0008           00176     return
                      00177  
01E3   14A5           00178     bsf     SNEXT        ; Taste gedrueckt
                      00179 
01E4   0BA4           00180     decfsz  tastennr,f   ; decrement Tastennr
01E5   0008           00181     return                ; wenn nicht null return
                      00182                        
01E6   300C           00183     movlw   12           ; sonst beginne bei 12
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 28
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01E7   00A4           00184     movwf   tastennr
01E8   0008           00185         return
                      00186 
01E9                  00187 NTasteNext
                      00188 
01E9   1CA5           00189     btfss   SNEXT        ; taste schon losgelassen ?
01EA   0008           00190     return               ; -> dann passts
                      00191   
01EB   10A5           00192     bcf     SNEXT        ; merke zustand
01EC   0008           00193         return
                      00194 
                      00195        ; --------------------  INITs -----------------
                      00196 
01ED                  00197 ports_init
01ED   1303           00198         bcf      STATUS, RP1    ; Bank 0
01EE   1283           00199         bcf      STATUS, RP0    ; am Start
01EF   018B           00200     clrf INTCON         ; sicher dass kein interrupt
01F0   018C           00201         CLRF    PIR1        ; clear periphial irq's
01F1   018D           00202         CLRF    PIR2        ; ditto
                      00203         
                      00204         ; make sure all individual irq's are disabled
01F2   308C           00205         MOVLW   PIE1    ; get adress for periphial irq enable
01F3   0084           00206         MOVWF   FSR     ; setup fsr
01F4   0180           00207         CLRF    INDF    ; and clear irq enable flags
                      00208 
01F5   308D           00209         MOVLW   PIE2    ; get adress for second periphial irq enable
01F6   0084           00210         MOVWF   FSR     ; setup fsr
01F7   0180           00211         CLRF    INDF    ; and clear irq enable flags
                      00212 
                      00213         ; --- Initial state before tristating outs ??? ---
                      00214 
01F8   2226           00215         call ClearRelais
                      00216 
                      00217         ; --- Init Button + timer ----
01F9   3001           00218     movlw   1           ; beginne bei 1
01FA   00A4           00219     movwf   tastennr
01FB   1025           00220     bcf     STEST
01FC   10A5           00221     bcf     SNEXT
01FD   01A6           00222     clrf    poti
                      00223 
01FE   01AD           00224         clrf    addresse
                      00225 
01FF   3004           00226     movlw   PRE_COUNT
0200   00A9           00227     movwf   precount
0201   01AA           00228     clrf    timecount0
0202   01AB           00229     clrf    timecount1
                      00230 
0203   2234           00231     call all_notes_off
                      00232 
                      00233 ;    movlw   0
                      00234 ;    movwf   hindex
                      00235 ;    call    SetHaltepuls
                      00236 ;     call    hpuls4
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 29
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00237 
                      00238         ; ------------- TRISTATE and IO-Pins Settings -------------
0204   1283           00239         bcf     STATUS, RP0             ; Bank0
                      00240 
                      00241     ; 10 FSC/64, 000 ADchannel0, 0 noconv, -, AD off 
                      00242     #define ADCON0_OFF B'10000000'
                      00243     #define ADCON0_ON  (ADCON0_OFF | 0x1)
                      00244 
                      00245 ;       movlw   ADCON0_OFF      ; NO AD
0205   3081           00246         movlw   ADCON0_ON       ; AD
0206   009F           00247         movwf   ADCON0
                      00248 
                      00249     ; ---------- PORT A and associated Pins ---------
0207   1683           00250         bsf     STATUS, RP0             ; Bank1 
                      00251 
                      00252     ; Init Analogconverter    
                      00253     ; leftalgined 0, 1 FSC/64, -, -, MODE only AN0 analog
0208   300E           00254         movlw   B'00001110'     ; 
0209   009F           00255         movwf   ADCON1^0x080
                      00256 
                      00257     ; CMCON C2OUT, C1OUT, C2INV, C1INV, CM
                      00258     ; CRVCON: CVRON, CVROE
                      00259 
                      00260         ; Port A -,-, 000 Outputs, 11111 Inputs 
020A   301F           00261         movlw   B'00011111' & DEBUGTRIS
020B   0085           00262         movwf   TRISA^0x080
                      00263 
                      00264     ; ---------- PORT B and associated Pins ---------
                      00265 
                      00266     ; OPTIONREG  RBPU, INETDG (for rb6,7 pgm)
                      00267 
                      00268         ; Port B        000000 6 Outputs,  2-Inputs (ICD)
020C   3000           00269         movlw   B'00000000'
020D   0086           00270         movwf   TRISB^0x080
                      00271 
                      00272 
                      00273     ; ---------- PORT C and associated REGs ---------    
                      00274 
                      00275         ; PORTC 10 (USART), 000000 6-outputs
020E   3080           00276         movlw   B'10000000'
020F   0087           00277         movwf   TRISC^0x080
                      00278         
                      00279         ; PORTD all Outputs
0210   3000           00280         movlw   B'00000000'
0211   0088           00281         movwf   TRISD^0x080
                      00282 
                      00283         ; PORTE all 3 Outputs
0212   1009           00284         bcf     TRISE^0x080,0
0213   1089           00285         bcf     TRISE^0x080,1
0214   1109           00286         bcf     TRISE^0x080,2
                      00287 
                      00288 
                      00289 ; ------ Setup timer --------------
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 30
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00290         ; Option =  Prescale
                      00291         ; + RBPU   - no pullups on PortB 
                      00292         ; + /PSA   - Prescaler to Timer0 (not WDT)
                      00293         ; + /TOSE  - Timer src edge not used
                      00294         ; + /T0CS  - Timer Clk source intern (CLK/4) 
                      00295         ; + /INTEDG sets button int to falling edge
                      00296 
0215   3080           00297         movlw   PRE_SCALE | (1 << NOT_RBPU) | USE_NPSA
                      00298     ;movlw   (1 << NOT_RBPU) | (1 << PSA) 
0216   0081           00299         movwf   OPTION_REG^0x080
                      00300 
0217   1283           00301         bcf     STATUS, RP0             ; Bank 0
0218   300F           00302         movlw   TMR0_LOAD       ; load timer
0219   0081           00303         movwf   TMR0
                      00304 
021A   2226           00305         call ClearRelais
                      00306 
                      00307         ; --- Interrupts enable (gie)+Timer0+RB0+RB4:7 ---
                      00308 ;       movlw  (1<<GIE)|(1<<T0IE)|(1<<INTE)|(1<<RBIE)
                      00309 ;       movlw  (1<<GIE)|(1<<INTE)|(1<<RBIE) ; no timer
021B   30A0           00310         movlw  (1<<GIE)|(1<<T0IE) ; only timer
                      00311 ;       movlw   0x00 
021C   008B           00312         movwf   INTCON
                      00313 
021D   0008           00314         return
                      00315 
                      00316              ; Adresse Einlesen
021E                  00317 init_adresse
                      00318              ; Adressbits fuer decodierung festlegen !!!
021E   01AD           00319     clrf     addresse
021F   1905           00320     btfsc    TADDR1
0220   162D           00321     bsf      ADDR1_BIT
0221   1985           00322     btfsc    TADDR2
0222   16AD           00323     bsf      ADDR2_BIT
0223   1A05           00324     btfsc    TADDR3
0224   172D           00325     bsf      ADDR3_BIT
0225   0008           00326     return
                      00327 
                      00328 ; 6) Helpers
                      00329 
                      00330 
0226                  00331 ClearRelais
                      00332 
0226   3017           00333     movlw 23
0227   00A7           00334     movwf relaisnr
0228   2005           00335         call     ClearPort     ; wenn nicht null dann ausfuehren    
0229   0BA7           00336         decfsz   relaisnr, f   ; decr nummer 
022A   2A28           00337     goto     $-2           ; loop 
022B   2005           00338         call     ClearPort     ; auch null ausfuehren   
022C   0008           00339     return                 ; fertig
                      00340 
022D                  00341 SetRelais
                      00342 
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 31
main.asm   - Autoklavier Main Test

LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

022D   3017           00343     movlw 23
022E   00A7           00344     movwf relaisnr
022F   2005           00345         call     ClearPort     ; wenn nicht null dann ausfuehren    
0230   0BA7           00346         decfsz   relaisnr, f   ; decr nummer 
0231   2A2F           00347     goto     $-2           ; loop 
0232   2005           00348         call     ClearPort     ; auch null ausfuehren   
0233   0008           00349     return                 ; fertig
                      00350 
0234                  00351 all_notes_off
                      00352 
0234   3031           00353     movlw   LOW puls0
0235   0084           00354     movwf   FSR
0236   300C           00355     movlw   12
0237   00A8           00356     movwf   nindex
                      00357    
0238                  00358 clear_notes
0238   0180           00359     clrf    INDF  ; puls++
0239   0A84           00360     incf    FSR, f
023A   0180           00361     clrf    INDF  ; note++
023B   0A84           00362     incf    FSR, f
023C   0BA8           00363     decfsz  nindex, f
023D   2A38           00364     goto    clear_notes
                      00365 
023E   2226           00366     call    ClearRelais
023F   0008           00367         return
                      00368 
                      00369  ; ------------- end --------------------
                      00370         end
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 32
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON0_OFF                        B'10000000'
ADCON0_ON                         (ADCON0_OFF | 0x1)
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADDR1_BIT                         addresse,addr1_bit
ADDR2_BIT                         addresse,addr2_bit
ADDR3_BIT                         addresse,addr3_bit
ADDRVALID                         PORTA,addrvalid
ADDR_MASK                         (1<<addr1_bit)|(1<<addr2_bit)|(1<<addr3_bit)
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
BAUD_RATE                         10
BCLIE                             00000003
BCLIF                             00000003
BF                                00000000
BRGH                              00000002
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 33
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

CDEBUGPIN                         
CDEBUGPIN1                        
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CIS                               00000003
CKE                               00000006
CKP                               00000004
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000009C
CMIE                              00000006
CMIF                              00000006
CREN                              00000004
CSRC                              00000007
CVR0                              00000000
CVR1                              00000001
CVR2                              00000002
CVR3                              00000003
CVRCON                            0000009D
CVREN                             00000007
CVROE                             00000006
CVRR                              00000005
ClearPort                         00000005
ClearPort2                        00000007
ClearRelais                       00000226
D                                 00000005
DATAVALID                         systemstatus,datavalid
DATAWAIT                          systemstatus,datawait
DATA_ADDRESS                      00000005
DAUERTEST                         schalter,4
DC                                00000001
DEBUGPIN                          DEBUGPORT, debugpin
DEBUGPIN1                         DEBUGPORT1, debugpin1
DEBUGPORT                         PORTA
DEBUGPORT1                        PORTA
DEBUGTRIS                         ~(0)
D_A                               00000005
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
F                                 00000001
FERR                              00000002
FSR                               00000004
GCEN                              00000007
GIE                               00000007
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 34
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

GO                                00000002
GO_DONE                           00000002
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
Int                               0000006B
IntEnd                            00000145
LIVEBIT                           systemstatus,livebit
Loop                              00000191
MINIMUM_VEL                       5
NOTENNRMASK                       B'00001111'
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
NTasteNext                        000001E9
NextTaste                         000001DE
OBF                               00000006
OERR                              00000001
OPTION_REG                        00000081
P                                 00000004
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 35
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
PR2                               00000092
PRE_COUNT                         (4)
PRE_SCALE                         B'000'
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
READ_WRITE                        00000002
REL0                              PORTA,rel0
REL1                              PORTE,rel1
REL10                             PORTD,rel10
REL11                             PORTD,rel11
REL12                             PORTC,rel12
REL13                             PORTC,rel13
REL14                             PORTD,rel14
REL15                             PORTD,rel15
REL16                             PORTD,rel16
REL17                             PORTD,rel17
REL18                             PORTB,rel18
REL19                             PORTB,rel19
REL2                              PORTE,rel2
REL20                             PORTB,rel20
REL21                             PORTB,rel21
REL22                             PORTB,rel22
REL23                             PORTB,rel23
REL3                              PORTE,rel3
REL4                              PORTC,rel4
REL5                              PORTC,rel5
REL6                              PORTD,rel6
REL7                              PORTD,rel7
REL8                              PORTC,rel8
REL9                              PORTC,rel9
RESET                             00000000
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 36
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

RP0                               00000005
RP1                               00000006
RSEN                              00000001
RX9                               00000006
RX9D                              00000000
R_W                               00000002
S                                 00000003
SDEBUGPIN                         
SDEBUGPIN1                        
SEN                               00000000
SMP                               00000007
SNEXT                             schalter,1
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
STATUS                            00000003
STATUS_BIT                        addresse,status_bit
STEST                             schalter,0
SYNC                              00000004
SerialIn                          00000195
SetPort                           00000038
SetPort2                          0000003A
SetRelais                         0000022D
Start                             0000018D
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TADDR1                            PORTA,taddr1
TADDR2                            PORTA,taddr2
TADDR3                            PORTA,taddr3
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 37
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

TESTVALID                         PORTA,testvalid
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR0_LOAD                         (256 - 241)
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TNEXT                             PORTA,tnext
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TPOTI                             PORTA,tpoti
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRISD                             00000088
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TTEST                             PORTA,ttest
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
TasteNext                         000001E1
TasteTest                         000001A4
TasteTestOff                      000001C4
TestTaste                         000001A0
UA                                00000001
USE_NPSA                          (0)
VALIDMASK                         (ADDR_MASK | (1 << status_bit))
W                                 00000000
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
Z                                 00000002
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 38
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00001FFF
_CP_OFF                           00003FFF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_1FOURTH                      00003BFF
_WRT_256                          00003DFF
_WRT_HALF                         000039FF
_WRT_OFF                          00003FFF
_XT_OSC                           00003FFD
__16F877A                         00000001
_fsr                              00000022
_pclath                           00000023
_status                           00000021
_version                          "2.1"
_w                                00000020
addr1_bit                         00000004
addr2_bit                         00000005
addr3_bit                         00000006
addresse                          0000002D
addrvalid                         00000001
all_notes_off                     00000234
clear_notes                       00000238
clear_rs                          00000188
data_received                     0000015F
datavalid                         00000001
datawait                          00000002
debugpin                          00000001
debugpin1                         00000002
disable_irq                       
enable_irq                        
halte_note                        
haltebit                          0
inbyte                            0000002E
init_adresse                      0000021E
int_serial_rx                     00000072
int_timer                         00000075
livebit                           00000000
n_haltebit                        00000003
n_neubit                          00000002
n_onbit                           00000000
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 39
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

n_pulsbit                         00000001
n_syncbit                         00000004
nindex                            00000028
note0                             00000032
note1                             00000034
note10                            00000046
note11                            00000048
note2                             00000036
note3                             00000038
note4                             0000003A
note5                             0000003C
note6                             0000003E
note7                             00000040
note8                             00000042
note9                             00000044
note_off                          0000016F
note_on                           00000164
notenr                            0000002F
parse_end                         0000017A
parse_input                       0000014C
play_note                         
ports_init                        000001ED
poti                              00000026
pre_tick                          0000007A
precount                          00000029
puls0                             00000031
puls1                             00000033
puls10                            00000045
puls11                            00000047
puls2                             00000035
puls3                             00000037
puls4                             00000039
puls5                             0000003B
puls6                             0000003D
puls7                             0000003F
puls8                             00000041
puls9                             00000043
rel0                              00000005
rel1                              00000000
rel10                             00000002
rel11                             00000003
rel12                             00000004
rel13                             00000005
rel14                             00000004
rel15                             00000005
rel16                             00000006
rel17                             00000007
rel18                             00000000
rel19                             00000001
rel2                              00000001
rel20                             00000002
rel21                             00000003
rel22                             00000004
MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 40
main.asm   - Autoklavier Main Test

SYMBOL TABLE
  LABEL                             VALUE 

rel23                             00000005
rel3                              00000002
rel4                              00000000
rel5                              00000001
rel6                              00000001
rel7                              00000000
rel8                              00000003
rel9                              00000002
relaisnr                          00000027
rs_init                           0000017B
schalter                          00000025
ser_err_end                       0000019E
status_bit                        00000007
systemstatus                      0000002C
taddr1                            00000002
taddr2                            00000003
taddr3                            00000004
tastennr                          00000024
tastenr_to_fsr                    
testvalid                         00000001
time_end                          00000145
time_tick                         0000013E
time_unit                         00000140
timecount0                        0000002A
timecount1                        0000002B
tnext                             00000004
tpoti                             00000000
ttest                             00000003
velo                              00000030
w_to_fsr                          


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX

All other memory blocks unused.

Program Memory Words Used:   576
Program Memory Words Free:  7616


MPASM 03.30 Released                                 MAIN.ASM   9-7-2005  18:17:06         PAGE 41
main.asm   - Autoklavier Main Test




Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,     0 suppressed

